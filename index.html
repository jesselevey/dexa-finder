
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Body Composition DEXA Finder</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #eff6ff 50%, #eef2ff 100%);
      min-height: 100vh;
      padding: 2rem 1rem;
    }
    .container { max-width: 800px; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 3rem; }
    .header-icon {
      display: inline-flex; align-items: center; justify-content: center;
      width: 64px; height: 64px;
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      border-radius: 16px; margin-bottom: 1.5rem;
      box-shadow: 0 10px 25px rgba(37,99,235,0.3);
    }
    h1 {
      font-family: Georgia, serif;
      font-size: clamp(2rem, 5vw, 3.5rem);
      font-weight: bold;
      background: linear-gradient(135deg, #0f172a, #1e3a8a, #312e81);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text; margin-bottom: 1rem; line-height: 1.2;
    }
    .subtitle { font-size: 1.1rem; color: #475569; max-width: 600px; margin: 0 auto; line-height: 1.6; }
    .search-card {
      background: white; border-radius: 24px; padding: 2rem; margin-bottom: 2rem;
      box-shadow: 0 10px 40px rgba(0,0,0,0.08); border: 1px solid #f1f5f9;
    }
    .search-label { display: block; font-size: 0.75rem; font-weight: 700; color: #374151; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.75rem; }
    .search-row { display: flex; gap: 0.75rem; flex-wrap: wrap; }
    .input-wrap { position: relative; flex: 1; min-width: 200px; }
    .input-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; stroke: #94a3b8; }
    input[type="text"] {
      width: 100%; padding: 1rem 1rem 1rem 3rem;
      border: 2px solid #e2e8f0; border-radius: 16px;
      font-size: 1.1rem; color: #0f172a; outline: none;
      transition: border-color 0.2s, box-shadow 0.2s; font-family: inherit;
    }
    input[type="text"]:focus { border-color: #3b82f6; box-shadow: 0 0 0 4px rgba(59,130,246,0.1); }
    #searchBtn {
      padding: 1rem 2rem;
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: white; font-weight: 700; font-size: 1rem; border: none;
      border-radius: 16px; cursor: pointer; display: flex; align-items: center;
      gap: 0.5rem; transition: all 0.2s; white-space: nowrap; font-family: inherit;
      box-shadow: 0 4px 15px rgba(37,99,235,0.3);
    }
    #searchBtn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(37,99,235,0.4); }
    #searchBtn:disabled { opacity: 0.6; cursor: not-allowed; }
    .error { margin-top: 1rem; color: #dc2626; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; }
    .error-dot { width: 8px; height: 8px; background: #dc2626; border-radius: 50%; flex-shrink: 0; }
    .results-title { font-family: Georgia, serif; font-size: 1.5rem; font-weight: bold; color: #0f172a; margin-bottom: 1.5rem; }
    .facility-card {
      background: white; border-radius: 20px; padding: 1.5rem; margin-bottom: 1rem;
      border: 1px solid #f1f5f9; box-shadow: 0 4px 20px rgba(0,0,0,0.06); transition: all 0.2s;
    }
    .facility-card:hover { border-color: #93c5fd; box-shadow: 0 8px 30px rgba(59,130,246,0.12); transform: translateY(-2px); }
    .facility-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; flex-wrap: wrap; }
    .facility-info { flex: 1; }
    .facility-name-row { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem; }
    .facility-name { font-family: Georgia, serif; font-size: 1.2rem; font-weight: bold; color: #0f172a; }
    .badge { padding: 2px 8px; background: #dcfce7; color: #15803d; font-size: 0.7rem; font-weight: 700; border-radius: 6px; border: 1px solid #bbf7d0; }
    .facility-detail { display: flex; align-items: flex-start; gap: 0.5rem; color: #475569; font-size: 0.9rem; margin-bottom: 0.4rem; }
    .facility-detail svg { width: 16px; height: 16px; stroke: #94a3b8; flex-shrink: 0; margin-top: 2px; }
    .facility-detail a { color: inherit; text-decoration: none; }
    .facility-detail a:hover { color: #2563eb; }
    .distance-badge {
      display: inline-flex; align-items: center; gap: 0.4rem;
      padding: 0.5rem 1rem; background: linear-gradient(135deg, #eff6ff, #eef2ff);
      border: 1px solid #bfdbfe; border-radius: 12px;
      font-weight: 700; color: #1e3a8a; white-space: nowrap;
    }
    .distance-badge svg { width: 16px; height: 16px; stroke: #2563eb; }
    .facility-actions { display: flex; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap; }
    .btn-directions {
      flex: 1; min-width: 130px; padding: 0.65rem 1rem;
      background: #f1f5f9; color: #374151; font-weight: 700; font-size: 0.9rem;
      border: none; border-radius: 12px; cursor: pointer; text-decoration: none;
      display: flex; align-items: center; justify-content: center; gap: 0.4rem;
      transition: background 0.2s; font-family: inherit;
    }
    .btn-directions:hover { background: #e2e8f0; }
    .btn-website {
      flex: 1; min-width: 130px; padding: 0.65rem 1rem;
      background: #2563eb; color: white; font-weight: 700; font-size: 0.9rem;
      border: none; border-radius: 12px; cursor: pointer; text-decoration: none;
      display: flex; align-items: center; justify-content: center; gap: 0.4rem;
      transition: background 0.2s; font-family: inherit;
    }
    .btn-website:hover { background: #1d4ed8; }
    .btn-directions svg, .btn-website svg { width: 16px; height: 16px; stroke: currentColor; }
    .info-box {
      margin-top: 3rem; background: linear-gradient(135deg, #1e3a8a, #312e81);
      border-radius: 24px; padding: 2rem; color: white;
      box-shadow: 0 20px 60px rgba(30,58,138,0.3);
    }
    .info-box h3 { font-family: Georgia, serif; font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; }
    .info-box p { color: #bfdbfe; line-height: 1.6; margin-bottom: 1.5rem; }
    .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; }
    .metric { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 1rem; }
    .metric-name { font-weight: 700; margin-bottom: 0.25rem; }
    .metric-desc { font-size: 0.8rem; color: #bfdbfe; }
    .spinner { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-icon">
        <svg width="32" height="32" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
        </svg>
      </div>
      <h1>Body Composition DEXA Finder</h1>
      <p class="subtitle">Find facilities offering comprehensive DEXA body composition scans including lean mass, fat mass, bone density, and visceral fat analysis</p>
    </div>

    <div class="search-card">
      <label class="search-label">Enter Your Address</label>
      <div class="search-row">
        <div class="input-wrap">
          <svg class="input-icon" fill="none" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          <input type="text" id="addressInput" placeholder="123 Main St, City, State ZIP" />
        </div>
        <button id="searchBtn" onclick="searchFacilities()">
          <svg fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24" width="20" height="20">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          Search
        </button>
      </div>
      <div id="errorMsg" class="error hidden">
        <div class="error-dot"></div>
        <span id="errorText"></span>
      </div>
    </div>

    <div id="results"></div>

    <div class="info-box">
      <h3>About Body Composition DEXA Scans</h3>
      <p>Comprehensive DEXA scans provide detailed analysis of your body composition beyond basic bone density. These advanced scans measure lean muscle mass, body fat percentage, visceral adipose tissue, and bone mineral density for a complete picture of your health and fitness.</p>
      <div class="metrics-grid">
        <div class="metric"><div class="metric-name">Lean Mass</div><div class="metric-desc">Muscle & tissue</div></div>
        <div class="metric"><div class="metric-name">Fat Mass</div><div class="metric-desc">Body fat %</div></div>
        <div class="metric"><div class="metric-name">Bone Density</div><div class="metric-desc">Skeletal health</div></div>
        <div class="metric"><div class="metric-name">Visceral Fat</div><div class="metric-desc">Organ fat levels</div></div>
      </div>
    </div>
  </div>

  <script>
    const addressInput = document.getElementById('addressInput');
    const errorMsg = document.getElementById('errorMsg');
    const errorText = document.getElementById('errorText');
    const results = document.getElementById('results');

    addressInput.addEventListener('keypress', e => { if (e.key === 'Enter') searchFacilities(); });

    function showError(msg) { errorText.textContent = msg; errorMsg.classList.remove('hidden'); }
    function hideError() { errorMsg.classList.add('hidden'); }

    function setLoading(on) {
      const btn = document.getElementById('searchBtn');
      btn.disabled = on;
      btn.innerHTML = on
        ? '<div class="spinner"></div> Searching...'
        : '<svg fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg> Search';
    }

    function calcDist(lat1, lon1, lat2, lon2) {
      const R = 3959, dLat = (lat2-lat1)*Math.PI/180, dLon = (lon2-lon1)*Math.PI/180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function renderFacilities(facilities) {
      if (!facilities.length) { results.innerHTML = ''; return; }
      const pinSvg = `<svg fill="none" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>`;
      const navSvg = `<svg fill="none" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>`;
      const extSvg = `<svg fill="none" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>`;
      const phoneSvg = `<svg fill="none" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>`;

      results.innerHTML = `<p class="results-title">Found ${facilities.length} Facilities Nearby</p>` +
        facilities.map(f => `
          <div class="facility-card">
            <div class="facility-top">
              <div class="facility-info">
                <div class="facility-name-row">
                  <span class="facility-name">${f.name}</span>
                  ${f.isBodyComp ? '<span class="badge">Body Composition</span>' : ''}
                </div>
                <div class="facility-detail">${pinSvg}<span>${f.address}</span></div>
                ${f.phone ? `<div class="facility-detail">${phoneSvg}<a href="tel:${f.phone}">${f.phone}</a></div>` : ''}
                ${f.rating ? `<div class="facility-detail"><span style="color:#f59e0b">â˜…</span><span>${f.rating} rating</span></div>` : ''}
              </div>
              <div class="distance-badge">${navSvg} ${f.distance} mi</div>
            </div>
            <div class="facility-actions">
              <a class="btn-directions" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(f.address)}" target="_blank" rel="noopener">
                ${pinSvg} Get Directions
              </a>
              ${f.website ? `<a class="btn-website" href="${f.website.startsWith('http') ? f.website : 'https://'+f.website}" target="_blank" rel="noopener">${extSvg} Visit Website</a>` : ''}
            </div>
          </div>`).join('');
    }

    async function searchFacilities() {
      const address = addressInput.value.trim();
      if (!address) { showError('Please enter an address'); return; }
      setLoading(true); hideError(); results.innerHTML = '';

      try {
        const res = await fetch('/api/search-dexa-facilities', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ address })
        });
        const data = await res.json();

        if (data.error) { showError(data.error); setLoading(false); return; }
        if (!data.facilities || !data.facilities.length) { showError('No DEXA scan facilities found near this address.'); setLoading(false); return; }

        const kw = ['body composition','body scan','fitness','performance','wellness','body fat','dexa','dxa'];
        const facilities = data.facilities
          .filter(p => p.latitude && p.longitude)
          .map(p => ({
            name: p.name || 'Unknown Facility',
            address: p.address || p.formatted_address || p.vicinity || '',
            phone: p.phone || p.formatted_phone_number || '',
            website: p.website || '',
            distance: Math.round(calcDist(data.userLocation.latitude, data.userLocation.longitude, p.latitude, p.longitude) * 10) / 10,
            rating: p.rating || null,
            isBodyComp: kw.some(k => (p.name||'').toLowerCase().includes(k))
          }))
          .sort((a,b) => { if (a.isBodyComp && !b.isBodyComp) return -1; if (!a.isBodyComp && b.isBodyComp) return 1; return a.distance-b.distance; })
          .slice(0, 15);

        renderFacilities(facilities);
      } catch (err) {
        showError('Error connecting to server. Please try again.');
        console.error(err);
      }
      setLoading(false);
    }
  </script>
</body>
</html>
