<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Body Composition DEXA Finder</title>
  <meta name="description" content="Find facilities offering comprehensive DEXA body composition scans including lean mass, fat mass, bone density, and visceral fat analysis">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React and ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel Standalone for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;
    const { MapPin, Search, Navigation, Phone, ExternalLink, Loader2 } = lucide;

    const DexaScanFinder = () => {
      const [address, setAddress] = useState('');
      const [facilities, setFacilities] = useState([]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [userLocation, setUserLocation] = useState(null);

      const calculateDistance = (lat1, lon1, lat2, lon2) => {
        const R = 3959; // Earth's radius in miles
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = 
          Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
          Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      };

      const searchFacilities = async () => {
        if (!address.trim()) {
          setError('Please enter an address');
          return;
        }

        setLoading(true);
        setError('');
        setFacilities([]);

        try {
          // First, get coordinates for the address
          const geocodeResponse = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 500,
              messages: [{
                role: 'user',
                content: `What are the GPS coordinates (latitude and longitude) for this address: "${address}"? Reply with ONLY a JSON object like {"latitude": 37.7749, "longitude": -122.4194} with no other text.`
              }]
            })
          });

          const geocodeData = await geocodeResponse.json();
          let userCoords = null;
          
          // Extract coordinates from response
          if (geocodeData.content && geocodeData.content[0]) {
            try {
              const coordText = geocodeData.content[0].text;
              const jsonMatch = coordText.match(/\{[^}]+\}/);
              if (jsonMatch) {
                userCoords = JSON.parse(jsonMatch[0]);
              }
            } catch (e) {
              console.error('Error parsing coordinates:', e);
            }
          }

          if (!userCoords || !userCoords.latitude || !userCoords.longitude) {
            setError('Could not find coordinates for that address. Please try a more specific address.');
            setLoading(false);
            return;
          }

          setUserLocation(userCoords);

          // Now search for DEXA facilities near those coordinates
          const searchResponse = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 4000,
              messages: [{
                role: 'user',
                content: `Find facilities near ${address} that offer comprehensive body composition DEXA scans (also called DXA scans). These facilities should specifically offer detailed body composition analysis including lean mass, fat mass, bone density, and visceral fat measurements - not just basic bone density screening. Look for: "body composition DEXA", "full body DEXA scan", "DEXA body composition analysis", "body fat DEXA scan", fitness/wellness DEXA facilities, sports performance centers with DEXA. Exclude basic medical bone density screening centers unless they also offer comprehensive body composition analysis. Return results as a JSON array where each facility has: name, address, phone (or null), rating (or null), latitude, longitude. Return ONLY the JSON array with no other text.`
              }],
              tools: [{
                type: "places_search_20250110",
                name: "places_search"
              }]
            })
          });

          const searchData = await searchResponse.json();
          console.log('Search response:', searchData);

          // Extract places from the response
          let allPlaces = [];
          
          if (searchData.content) {
            for (const block of searchData.content) {
              // Look for text blocks containing JSON
              if (block.type === 'text') {
                try {
                  const text = block.text.trim();
                  // Try to find JSON array in the text
                  const jsonMatch = text.match(/\[\s*\{[\s\S]*\}\s*\]/);
                  if (jsonMatch) {
                    const places = JSON.parse(jsonMatch[0]);
                    allPlaces = allPlaces.concat(places);
                  }
                } catch (e) {
                  console.error('Error parsing places JSON:', e);
                }
              }
              
              // Also check for tool_result blocks which contain the actual places data
              if (block.type === 'tool_result') {
                try {
                  const resultContent = typeof block.content === 'string' 
                    ? JSON.parse(block.content) 
                    : block.content;
                  
                  if (resultContent.places && Array.isArray(resultContent.places)) {
                    allPlaces = allPlaces.concat(resultContent.places);
                  }
                } catch (e) {
                  console.error('Error parsing tool result:', e);
                }
              }
            }
          }

          console.log('Extracted places:', allPlaces);

          // Calculate distances and format facilities
          if (allPlaces.length > 0) {
            const bodyCompKeywords = [
              'body composition',
              'body scan',
              'fitness',
              'performance',
              'wellness',
              'body fat',
              'dexa',
              'dxa'
            ];

            const facilitiesWithDistance = allPlaces
              .filter(place => place.latitude && place.longitude)
              .map(place => {
                const distance = calculateDistance(
                  userCoords.latitude,
                  userCoords.longitude,
                  place.latitude,
                  place.longitude
                );
                
                const name = (place.name || '').toLowerCase();
                const hasBodyCompKeyword = bodyCompKeywords.some(keyword => name.includes(keyword));
                
                return {
                  name: place.name || 'Unknown Facility',
                  address: place.address || place.formatted_address || place.vicinity || '',
                  phone: place.phone || place.formatted_phone_number || '',
                  distance: Math.round(distance * 10) / 10, // Round to 1 decimal
                  rating: place.rating || null,
                  place_id: place.place_id || '',
                  website: place.website || '',
                  isBodyCompFocused: hasBodyCompKeyword
                };
              })
              .sort((a, b) => {
                // Prioritize body composition focused facilities, then by distance
                if (a.isBodyCompFocused && !b.isBodyCompFocused) return -1;
                if (!a.isBodyCompFocused && b.isBodyCompFocused) return 1;
                return a.distance - b.distance;
              })
              .slice(0, 15); // Limit to top 15 results

            if (facilitiesWithDistance.length > 0) {
              setFacilities(facilitiesWithDistance);
            } else {
              setError('No DEXA scan facilities found near this address. Try a different location or search radius.');
            }
          } else {
            setError('No DEXA scan facilities found near this address. This may be a location where these services are limited.');
          }

          setLoading(false);

        } catch (err) {
          console.error('Search error:', err);
          setError(`Error searching for facilities: ${err.message}. Please try again.`);
          setLoading(false);
        }
      };

      const handleKeyPress = (e) => {
        if (e.key === 'Enter') {
          searchFacilities();
        }
      };

      // Create icon components
      const Icon = ({ icon, className }) => {
        const IconComponent = lucide[icon];
        return React.createElement(IconComponent, { className });
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">
          <div className="max-w-4xl mx-auto px-4 py-8 md:py-16">
            {/* Header */}
            <div className="text-center mb-12">
              <div className="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-2xl mb-6 shadow-lg shadow-blue-500/30">
                <Icon icon="Navigation" className="w-8 h-8 text-white" />
              </div>
              <h1 className="text-5xl md:text-6xl font-bold mb-4 bg-gradient-to-r from-slate-900 via-blue-900 to-indigo-900 bg-clip-text text-transparent" style={{ fontFamily: 'Georgia, serif' }}>
                Body Composition DEXA Finder
              </h1>
              <p className="text-lg text-slate-600 max-w-2xl mx-auto" style={{ fontFamily: 'system-ui, sans-serif' }}>
                Find facilities offering comprehensive DEXA body composition scans including lean mass, fat mass, bone density, and visceral fat analysis
              </p>
            </div>

            {/* Search Box */}
            <div className="bg-white rounded-3xl shadow-xl shadow-slate-200/50 p-8 mb-8 border border-slate-100">
              <label className="block text-sm font-semibold text-slate-700 mb-3 uppercase tracking-wide" style={{ fontFamily: 'system-ui, sans-serif' }}>
                Enter Your Address
              </label>
              <div className="flex gap-3">
                <div className="relative flex-1">
                  <Icon icon="MapPin" className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" />
                  <input
                    type="text"
                    value={address}
                    onChange={(e) => setAddress(e.target.value)}
                    onKeyPress={handleKeyPress}
                    placeholder="123 Main St, City, State ZIP"
                    className="w-full pl-12 pr-4 py-4 border-2 border-slate-200 rounded-2xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all text-slate-900 text-lg"
                    style={{ fontFamily: 'system-ui, sans-serif' }}
                  />
                </div>
                <button
                  onClick={searchFacilities}
                  disabled={loading}
                  className="px-8 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold rounded-2xl transition-all shadow-lg shadow-blue-500/30 hover:shadow-xl hover:shadow-blue-500/40 hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center gap-2"
                  style={{ fontFamily: 'system-ui, sans-serif' }}
                >
                  {loading ? (
                    <>
                      <Icon icon="Loader2" className="w-5 h-5 animate-spin" />
                      Searching...
                    </>
                  ) : (
                    <>
                      <Icon icon="Search" className="w-5 h-5" />
                      Search
                    </>
                  )}
                </button>
              </div>
              {error && (
                <p className="mt-4 text-red-600 text-sm flex items-center gap-2">
                  <span className="w-2 h-2 bg-red-600 rounded-full"></span>
                  {error}
                </p>
              )}
            </div>

            {/* Results */}
            {facilities.length > 0 && (
              <div className="space-y-4">
                <h2 className="text-2xl font-bold text-slate-900 mb-6" style={{ fontFamily: 'Georgia, serif' }}>
                  Found {facilities.length} Facilities Nearby
                </h2>
                {facilities.map((facility, index) => (
                  <div
                    key={index}
                    className="bg-white rounded-2xl shadow-lg shadow-slate-200/50 p-6 border border-slate-100 hover:border-blue-300 hover:shadow-xl hover:shadow-blue-100/50 transition-all duration-300 hover:-translate-y-1"
                    style={{ animationDelay: `${index * 100}ms` }}
                  >
                    <div className="flex items-start justify-between mb-3">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-2">
                          <h3 className="text-xl font-bold text-slate-900" style={{ fontFamily: 'Georgia, serif' }}>
                            {facility.name}
                          </h3>
                          {facility.isBodyCompFocused && (
                            <span className="px-2 py-1 bg-green-100 text-green-700 text-xs font-semibold rounded-md border border-green-200">
                              Body Composition
                            </span>
                          )}
                        </div>
                        <p className="text-slate-600 flex items-start gap-2 mb-2">
                          <Icon icon="MapPin" className="w-4 h-4 mt-1 flex-shrink-0 text-slate-400" />
                          <span style={{ fontFamily: 'system-ui, sans-serif' }}>{facility.address}</span>
                        </p>
                        {facility.phone && (
                          <p className="text-slate-600 flex items-center gap-2 mb-2">
                            <Icon icon="Phone" className="w-4 h-4 flex-shrink-0 text-slate-400" />
                            <a href={`tel:${facility.phone}`} className="hover:text-blue-600 transition-colors" style={{ fontFamily: 'system-ui, sans-serif' }}>
                              {facility.phone}
                            </a>
                          </p>
                        )}
                        {facility.rating && (
                          <p className="text-slate-600 flex items-center gap-2">
                            <span className="text-yellow-500">â˜…</span>
                            <span style={{ fontFamily: 'system-ui, sans-serif' }}>{facility.rating} rating</span>
                          </p>
                        )}
                      </div>
                      <div className="text-right ml-4">
                        <div className="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200">
                          <Icon icon="Navigation" className="w-4 h-4 text-blue-600" />
                          <span className="font-bold text-blue-900" style={{ fontFamily: 'system-ui, sans-serif' }}>
                            {facility.distance} mi
                          </span>
                        </div>
                      </div>
                    </div>
                    <div className="flex gap-3 mt-4">
                      <a
                        href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(facility.address)}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="flex-1 px-4 py-2.5 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold rounded-xl transition-colors text-center flex items-center justify-center gap-2"
                        style={{ fontFamily: 'system-ui, sans-serif' }}
                      >
                        <Icon icon="MapPin" className="w-4 h-4" />
                        Get Directions
                      </a>
                      {facility.website && (
                        <a
                          href={facility.website.startsWith('http') ? facility.website : `https://${facility.website}`}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="flex-1 px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl transition-colors text-center flex items-center justify-center gap-2"
                          style={{ fontFamily: 'system-ui, sans-serif' }}
                        >
                          <Icon icon="ExternalLink" className="w-4 h-4" />
                          Visit Website
                        </a>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            )}

            {/* Info Box */}
            <div className="mt-12 bg-gradient-to-br from-blue-900 to-indigo-900 rounded-3xl p-8 text-white shadow-2xl shadow-blue-900/30">
              <h3 className="text-2xl font-bold mb-4" style={{ fontFamily: 'Georgia, serif' }}>
                About Body Composition DEXA Scans
              </h3>
              <p className="text-blue-100 leading-relaxed mb-4" style={{ fontFamily: 'system-ui, sans-serif' }}>
                Comprehensive DEXA scans provide detailed analysis of your body composition beyond basic bone density. These advanced scans measure lean muscle mass, body fat percentage, visceral adipose tissue, and bone mineral density for a complete picture of your health and fitness.
              </p>
              <div className="grid md:grid-cols-4 gap-4 mt-6">
                <div className="bg-white/10 backdrop-blur rounded-xl p-4 border border-white/20">
                  <div className="font-bold mb-1" style={{ fontFamily: 'system-ui, sans-serif' }}>Lean Mass</div>
                  <div className="text-sm text-blue-200" style={{ fontFamily: 'system-ui, sans-serif' }}>Muscle & tissue</div>
                </div>
                <div className="bg-white/10 backdrop-blur rounded-xl p-4 border border-white/20">
                  <div className="font-bold mb-1" style={{ fontFamily: 'system-ui, sans-serif' }}>Fat Mass</div>
                  <div className="text-sm text-blue-200" style={{ fontFamily: 'system-ui, sans-serif' }}>Body fat %</div>
                </div>
                <div className="bg-white/10 backdrop-blur rounded-xl p-4 border border-white/20">
                  <div className="font-bold mb-1" style={{ fontFamily: 'system-ui, sans-serif' }}>Bone Density</div>
                  <div className="text-sm text-blue-200" style={{ fontFamily: 'system-ui, sans-serif' }}>Skeletal health</div>
                </div>
                <div className="bg-white/10 backdrop-blur rounded-xl p-4 border border-white/20">
                  <div className="font-bold mb-1" style={{ fontFamily: 'system-ui, sans-serif' }}>Visceral Fat</div>
                  <div className="text-sm text-blue-200" style={{ fontFamily: 'system-ui, sans-serif' }}>Organ fat levels</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<DexaScanFinder />, document.getElementById('root'));
  </script>
</body>
</html>
